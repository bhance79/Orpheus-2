<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Orpheus 2.0</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Tailwind config - lavender/cornflower blue theme
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#7B68EE',
              'primary-hover': '#9D8DF1',
              'primary-dark': '#5E4FD1',
              'bg-dark': '#0A0A0F',
              'bg-card': '#16161D',
              'bg-elevated': '#1E1E28',
              'bg-input': '#2D2D3D',
              'border': '#2D2D3D',
              'text-primary': '#E8E8F0',
              'text-secondary': '#A8A8BA',
              'text-muted': '#70708C',
            }
          }
        }
      }
    </script>

    <!-- Alpine.js CDN -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Custom styles (we'll gradually migrate these to Tailwind) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script defer src="{{ url_for('static', filename='app.js') }}"></script>
  </head>
  <body>
    <!-- Alpine.js app wrapper -->
    <div x-data="orpheusApp()" x-cloak class="app-layout">

      {% if playlists %}
      <!-- Sidebar Navigation -->
      <aside class="sidebar"
             @mouseenter="sidebarExpanded = true"
             @mouseleave="sidebarExpanded = false"
             :class="sidebarExpanded ? 'expanded' : ''">

        <!-- Logo/Brand at top -->
        <div class="sidebar-header">
          <div class="sidebar-icon">
            <img src="{{ url_for('static', filename='icons/home-icon-w.png') }}" alt="Orpheus Logo">
          </div>
          <div class="sidebar-text">Orpheus</div>
        </div>

        <!-- Navigation Items -->
        <nav class="sidebar-nav">
          <button type="button"
                  @click="switchView('home')"
                  :class="currentView === 'home' ? 'active' : ''"
                  class="sidebar-item">
            <div class="sidebar-icon">
              <img src="{{ url_for('static', filename='icons/home-icon-w.png') }}" alt="Dashboard">
            </div>
            <div class="sidebar-text">Dashboard</div>
          </button>

          <button type="button"
                  @click="switchView('view-tracks')"
                  :class="currentView === 'view-tracks' ? 'active' : ''"
                  class="sidebar-item">
            <div class="sidebar-icon">
              <img src="{{ url_for('static', filename='icons/playlist-view-w.png') }}" alt="View Tracks">
            </div>
            <div class="sidebar-text">View Tracks</div>
          </button>

          <button type="button"
                  @click="switchView('remove-duplicates')"
                  :class="currentView === 'remove-duplicates' ? 'active' : ''"
                  class="sidebar-item">
            <div class="sidebar-icon">
              <img src="{{ url_for('static', filename='icons/remove-dupes-w.png') }}" alt="Remove Duplicates">
            </div>
            <div class="sidebar-text">Remove Duplicates</div>
          </button>

          <button type="button"
                  @click="switchView('filter-sweep')"
                  :class="currentView === 'filter-sweep' ? 'active' : ''"
                  class="sidebar-item">
            <div class="sidebar-icon">
              <img src="{{ url_for('static', filename='icons/sweep-icon-w.png') }}" alt="Filter Sweep">
            </div>
            <div class="sidebar-text">Filter Sweep</div>
          </button>
        </nav>

        <!-- Logout at bottom -->
        <div class="sidebar-footer">
          <a href="{{ url_for('logout') }}" class="sidebar-item">
            <div class="sidebar-icon">
              <img src="{{ url_for('static', filename='icons/logout-w.png') }}" alt="Logout">
            </div>
            <div class="sidebar-text">Logout</div>
          </a>
        </div>
      </aside>
      {% endif %}

      <!-- Main Content Area -->
      <div class="main-content">
        <!-- Top Header Card -->
        <!-- ALPINE TEST -->
        <div style="background: blue; color: white; padding: 1rem; margin: 1rem;">
          <p><strong>Alpine.js Test:</strong></p>
          <p x-data="{ test: 'Alpine is WORKING!' }" x-text="test"></p>
          <p>Current view: <span x-text="currentView"></span></p>
        </div>

        <header class="top-bar">
          <div class="user-info">
            {% if user_image %}
              <img src="{{ user_image }}" alt="{{ user_name }}" class="profile-pic">
            {% endif %}
            <h1>
              <!-- Click to go back to home view (client-side navigation) -->
              <a @click.prevent="switchView('home')" href="{{ url_for('index') }}" class="home-link font-bold cursor-pointer">Welcome back, {{ user_name or 'User' }}</a>
            </h1>
          </div>
          <!-- Debug: Current view -->
          <div class="text-xs text-yellow-400" x-text="'DEBUG: Current view = ' + currentView"></div>
        </header>

      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <div class="flash" role="status" aria-live="polite">
            {% for message in messages %}
              <div class="flash-item">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      {% if not playlists %}
        <div class="container">
          <p><a href="{{ url_for('login') }}" class="btn">Login with Spotify</a></p>
        </div>
      {% else %}

        <!-- ========== VIEW 1: DASHBOARD (HOME) ========== -->
        <template x-if="currentView === 'home'">
          <div x-init="loadDashboardStats()" class="view-container">
          <div class="container">
            <h2 class="text-2xl font-bold mb-4">Your Music Dashboard</h2>

          <!-- Featured Top Artists Showcase -->
          <div class="card mb-6 top-artists-card">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
              <div>
                <div class="text-sm text-gray-400 uppercase tracking-wide">Spotlight</div>
                <h3 class="text-2xl font-semibold">Your Top Artists</h3>
                <div class="text-sm text-gray-400">
                  Range:
                  <span class="text-white font-semibold" x-text="rangeLabels[activeArtistRange] || ''"></span>
                </div>
              </div>
              <div class="flex flex-col gap-2 items-start sm:items-end">
                <div class="flex flex-wrap gap-2" role="group" aria-label="Select artist range">
                  <template x-for="range in rangeOptions" :key="`artist-${range}`">
                    <button
                      type="button"
                      class="px-3 py-1 text-xs font-medium rounded-full border transition"
                      :class="activeArtistRange === range ? 'bg-primary text-white border-primary' : 'border-gray-600 text-gray-400 hover:text-white'"
                      @click="setRange('artists', range)"
                    >
                      <span x-text="rangeLabels[range] || range"></span>
                    </button>
                  </template>
                </div>
                <button type="button"
                        class="link-btn"
                        :class="!canShowMore('artists') ? 'link-btn--disabled' : ''"
                        :disabled="!canShowMore('artists')"
                        @click="openTopModal('artists')">
                  View full list
                </button>
              </div>
            </div>
            <div class="overflow-x-auto pb-2 top-artists-hero">
              <div id="top-artists-hero" class="flex gap-6 min-w-max">
                <div class="text-sm text-gray-400">Loading your favorites...</div>
              </div>
            </div>
          </div>

          <!-- Top Tracks -->
          <div class="card mb-6">
            <div class="flex items-center justify-between mb-3 gap-4">
              <div>
                <h3 class="text-lg font-semibold">Top Tracks</h3>
                <div class="text-sm text-gray-400">
                  Range:
                  <span class="text-white font-semibold" x-text="rangeLabels[activeTrackRange] || ''"></span>
                </div>
              </div>
              <div class="flex flex-col gap-2 items-start sm:items-end">
                <div class="flex flex-wrap gap-2" role="group" aria-label="Select track range">
                  <template x-for="range in rangeOptions" :key="`track-${range}`">
                    <button
                      type="button"
                      class="px-3 py-1 text-xs font-medium rounded-full border transition"
                      :class="activeTrackRange === range ? 'bg-primary text-white border-primary' : 'border-gray-600 text-gray-400 hover:text-white'"
                      @click="setRange('tracks', range)"
                    >
                      <span x-text="rangeLabels[range] || range"></span>
                    </button>
                  </template>
                </div>
                <button type="button"
                        class="link-btn"
                        :class="!canShowMore('tracks') ? 'link-btn--disabled' : ''"
                        :disabled="!canShowMore('tracks')"
                        @click="openTopModal('tracks')">
                  Show more
                </button>
              </div>
            </div>
            <div id="top-tracks-list" class="space-y-2">
              <div class="text-sm text-gray-400">Loading...</div>
            </div>
          </div>

          <!-- Top Genres -->
          <div class="card mb-6">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
              <div>
                <h3 class="text-lg font-semibold">Top Genres</h3>
                <div class="text-sm text-gray-400">
                  <span x-text="genreSourceLabels[activeGenreSource] || ''"></span>
                  ·
                  <span x-text="rangeLabels[activeGenreRange] || ''"></span>
                </div>
              </div>
              <div class="flex flex-wrap gap-4">
                <div>
                  <div class="text-xs text-gray-400 uppercase tracking-wide mb-1">Source</div>
                  <div class="flex gap-2">
                    <template x-for="source in genreSourceOptions" :key="source">
                      <button
                        type="button"
                        class="range-chip"
                        :class="activeGenreSource === source ? 'range-chip--active' : ''"
                        @click="setGenreSource(source)"
                      >
                        <span x-text="genreSourceLabels[source] || source"></span>
                      </button>
                    </template>
                  </div>
                </div>
                <div>
                  <div class="text-xs text-gray-400 uppercase tracking-wide mb-1">Range</div>
                  <div class="flex gap-2">
                    <template x-for="range in genreRangeOptions" :key="`genre-${range}`">
                      <button
                        type="button"
                        class="range-chip"
                        :class="activeGenreRange === range ? 'range-chip--active' : ''"
                        @click="setGenreRange(range)"
                      >
                        <span x-text="rangeLabels[range] || range"></span>
                      </button>
                    </template>
                  </div>
                </div>
              </div>
            </div>
            <div id="top-genres-chart" class="genre-chart">
              <div class="text-sm text-gray-400">Loading...</div>
            </div>
          </div>

          <!-- Recently Played -->
          <div class="card mb-6">
            <h3 class="text-lg font-semibold mb-3">Recently Played</h3>
            <div id="recently-played-list" class="space-y-2 recently-played-scroll">
              <div class="text-sm text-gray-400">Loading...</div>
            </div>
          </div>
          </div>
        </template>

        <!-- ========== VIEW 2: VIEW TRACKS ========== -->
        <template x-if="currentView === 'view-tracks'">
          <div>
            <div style="background: red; color: white; padding: 1rem; margin: 1rem; border-radius: 8px;">
              <h2 style="font-size: 1.5rem; font-weight: bold; margin: 0 0 0.5rem 0;">✓ VIEW TRACKS IS VISIBLE</h2>
              <p style="margin: 0;">This red box confirms the view is rendering correctly.</p>
            </div>

            <div class="view-container">
              <div class="container">
                <h2 class="text-xl font-bold mb-4">View Playlist Tracks</h2>

                <!-- Playlist Selection Form -->
                <form id="view-tracks-form" class="inline-form" method="post" action="{{ url_for('select') }}">
                  <label for="playlist_id">Select a playlist:</label>
                  <div class="form-row">
                    <select name="playlist_id" id="playlist_id" required>
                      <option value="__recent__">Recently Played</option>
                      {% for playlist in owned_playlists %}
                        <option value="{{ playlist.id }}"
                          {% if playlist.name|lower == default_playlist|lower %}selected{% endif %}>
                          {{ playlist.name }}
                        </option>
                      {% endfor %}
                    </select>

                    <button type="submit" class="btn">Load Tracks</button>
                  </div>
                </form>

                <!-- Track Results -->
                <div id="tracks-card" class="card hidden" aria-live="polite"></div>
              </div>
            </div>
          </div>
        </template>

        <!-- ========== VIEW 3: REMOVE DUPLICATES ========== -->
        <template x-if="currentView === 'remove-duplicates'">
          <div class="view-container">
            <div class="container">
              <div class="text-xs text-green-400 mb-2">DEBUG: Remove Duplicates is visible</div>
              <h2 class="text-xl font-bold mb-2">Remove Duplicate Tracks</h2>
          <p class="muted mb-4">
            Check your playlists for duplicate tracks and remove them. Only playlists you own can be modified.
          </p>

          <!-- Step 1: Select Playlist -->
          <div id="duplicate-check-form" class="mb-6">
            <label for="duplicate_playlist_id">Select a playlist to check:</label>
            <div class="form-row">
              <select id="duplicate_playlist_id" required>
                <option value="">-- Choose a playlist --</option>
                {% for playlist in owned_playlists %}
                  <option value="{{ playlist.id }}">{{ playlist.name }}</option>
                {% endfor %}
              </select>
              <button type="button" id="check-duplicates-btn" class="btn">Check for Duplicates</button>
            </div>
          </div>

          <!-- Step 2: Show Results -->
          <div id="duplicate-results" class="hidden">
            <!-- No duplicates message -->
            <div id="no-duplicates-msg" class="card hidden">
              <div class="flex items-center gap-3">
                <div class="text-4xl">✓</div>
                <div>
                  <h3 class="text-lg font-semibold text-green-400">No Duplicates Found!</h3>
                  <p class="muted">This playlist is clean - no duplicate tracks detected.</p>
                </div>
              </div>
            </div>

            <!-- Duplicates found -->
            <div id="duplicates-found" class="hidden">
              <div class="card mb-4">
                <div class="flex items-center justify-between mb-3">
                  <div>
                    <h3 class="text-lg font-semibold text-yellow-400">Duplicates Found</h3>
                    <p class="muted">Found <strong id="duplicate-count">0</strong> duplicate track(s) in this playlist.</p>
                  </div>
                </div>

                <!-- Duplicate tracks list -->
                <div id="duplicate-tracks-list" class="space-y-2 mb-4">
                  <!-- Will be populated by JavaScript -->
                </div>

                <!-- Action buttons -->
                <div class="flex gap-3 border-t border-gray-700 pt-4">
                  <button type="button" id="confirm-remove-duplicates" class="btn btn-accent">
                    Remove All Duplicates
                  </button>
                  <button type="button" @click="switchView('home')" class="btn btn-secondary">
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>
          </div>
        </template>

        <!-- ========== VIEW 4: FILTER SWEEP ========== -->
        <template x-if="currentView === 'filter-sweep'">
          <div class="view-container">
          <div class="container">
            <div class="text-xs text-green-400 mb-2">DEBUG: Filter Sweep is visible</div>
            <h2 class="text-xl font-bold mb-2">Filter Sweep</h2>
          <p class="muted mb-4">
            Remove from <strong>playlist A</strong> (must be owned by you) any tracks that also appear in
            one or more <strong>playlist B</strong> selections.
          </p>

          <form id="filter-sweep-form" method="post" action="{{ url_for('filter_sweep') }}">
            <label for="playlist_a_id">Playlist A (Source):</label>
            <select name="playlist_a_id" id="playlist_a_id" required>
              {% for playlist in owned_playlists %}
                <option value="{{ playlist.id }}"
                  {% if playlist.name|lower == default_playlist|lower %}selected{% endif %}>
                  {{ playlist.name }}
                </option>
              {% endfor %}
            </select>

            <div class="label-row">
              <label for="playlist_b_id">Playlist B (Reference — select one or more):</label>
              <div class="label-actions">
                <span id="playlist-b-count" class="pill" aria-live="polite">0 selected</span>
                <button type="button" class="btn btn-secondary xsmall-btn deselect-all-btn">Deselect All</button>
              </div>
            </div>

            <select name="playlist_b_id" id="playlist_b_id" multiple size="10" required>
              {% for playlist in playlists %}
                <option value="{{ playlist.id }}">{{ playlist.name }}</option>
              {% endfor %}
            </select>

            <button id="filter-sweep-submit" type="submit" class="btn btn-accent">Run Filter Sweep</button>
          </form>
          </div>
          </div>
        </template>

      {% endif %}
      </div> <!-- Close main-content -->
    </div> <!-- Close app-layout -->

    <!-- Top Items Modal -->
    <div x-cloak
         x-show="showTopModal"
         class="modal-backdrop"
         @click="closeTopModal()"
         @keydown.escape.window="closeTopModal()"
         role="dialog"
         aria-modal="true">
      <div class="modal-panel" @click.stop x-transition>
        <div class="modal-header">
          <h3 class="modal-title" x-text="modalTitle || 'Top Items'"></h3>
          <button type="button" class="modal-close" @click="closeTopModal()" aria-label="Close dialog">×</button>
        </div>
        <div class="modal-range" x-show="rangeOptions.length > 0">
          <div class="modal-range-label">Time range:</div>
          <div class="modal-range-chips">
            <template x-for="range in rangeOptions" :key="`modal-${range}`">
              <button
                type="button"
                class="range-chip"
                :class="(modalType === 'artists' ? activeArtistRange : activeTrackRange) === range ? 'range-chip--active' : ''"
                @click.stop="setRange(modalType || 'artists', range)"
              >
                <span x-text="rangeLabels[range] || range"></span>
              </button>
            </template>
          </div>
        </div>
        <template x-if="modalItems.length === 0">
          <div class="text-sm text-gray-400">No data available for this range.</div>
        </template>
        <div class="modal-content" x-show="modalItems.length > 0">
          <div class="modal-list" role="list">
            <template x-for="(item, index) in modalItems" :key="`${modalType}-${index}`">
              <div class="modal-list-item" role="listitem">
                <div class="modal-rank" x-text="index + 1"></div>
                <div class="modal-body">
                  <div class="modal-item" x-show="modalType === 'artists'">
                    <template x-if="item.image">
                      <img :src="item.image" :alt="item.name" class="modal-avatar">
                    </template>
                    <template x-if="!item.image">
                      <div class="modal-avatar placeholder"></div>
                    </template>
                    <div class="modal-info">
                      <a :href="item.url" target="_blank" rel="noopener" class="modal-link" x-text="item.name"></a>
                      <div class="modal-subtext" x-text="item.genres && item.genres.length ? item.genres.join(', ') : 'Genre unavailable'"></div>
                    </div>
                  </div>

                  <div class="modal-item" x-show="modalType === 'tracks'">
                    <template x-if="item.cover">
                      <img :src="item.cover"
                           :alt="item.name"
                           class="modal-track-cover">
                    </template>
                    <template x-if="!item.cover">
                      <div class="modal-track-cover placeholder"></div>
                    </template>
                    <div class="modal-info">
                      <a :href="item.url" target="_blank" rel="noopener" class="modal-link block truncate" x-text="item.name"></a>
                      <div class="modal-subtext truncate" x-text="item.artists"></div>
                      <div class="modal-subtext muted truncate" x-text="item.album || 'Album unavailable'"></div>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>

    <!-- Sweeping overlay -->
    <div id="sweep-overlay" class="overlay" aria-hidden="true">
      <div class="overlay-content" role="alert" aria-live="assertive">
        <div class="spinner" aria-hidden="true"></div>
        <div class="overlay-text">Loading...</div>
      </div>
    </div>

    <!-- Alpine.js Component Logic -->
    <script>
      function orpheusApp() {
        return {
          currentView: 'home', // Default view: 'home', 'view-tracks', 'remove-duplicates', 'filter-sweep'
          statsLoaded: false,
          sidebarExpanded: false,
          rangeOptions: ['short_term', 'medium_term', 'long_term'],
          rangeLabels: {
            short_term: 'Last 4 Weeks',
            medium_term: 'Last 6 Months',
            long_term: 'All Time'
          },
          activeArtistRange: 'short_term',
          activeTrackRange: 'short_term',
          topArtistsByRange: {},
          topTracksByRange: {},
          topGenresBySource: { artists: {}, tracks: {} },
          genreSourceLabels: { artists: 'Top Artists', tracks: 'Top Tracks' },
          genreSourceOptions: ['artists', 'tracks'],
          genreRangeOptions: ['short_term', 'medium_term', 'long_term'],
          activeGenreSource: 'artists',
          activeGenreRange: 'short_term',
          showTopModal: false,
          modalType: null,
          modalItems: [],
          modalTitle: '',

          switchView(viewName) {
            console.log('Switching to view:', viewName);
            this.currentView = viewName;
            console.log('Current view is now:', this.currentView);
            // Scroll to top when switching views
            window.scrollTo({ top: 0, behavior: 'smooth' });
          },

          selectPlaylistAndView(playlistId) {
            // Switch to view-tracks view
            this.switchView('view-tracks');

            // Wait for view to render, then set playlist and trigger form
            setTimeout(() => {
              const select = document.getElementById('playlist_id');
              const form = document.getElementById('view-tracks-form');
              if (select && form) {
                select.value = playlistId;
                form.dispatchEvent(new Event('submit'));
              }
            }, 100);
          },

          setRange(type, rangeKey) {
            if (type === 'artists') {
              if (this.activeArtistRange === rangeKey) return;
              this.activeArtistRange = rangeKey;
              this.renderArtistShowcase();
            } else if (type === 'tracks') {
              if (this.activeTrackRange === rangeKey) return;
              this.activeTrackRange = rangeKey;
              this.renderTopTracksPreview();
            }
            if (this.showTopModal && this.modalType === type) {
              this.updateModalItems();
            }
          },

          canShowMore(type) {
            const dataMap = type === 'artists' ? this.topArtistsByRange : this.topTracksByRange;
            const rangeKey = type === 'artists' ? this.activeArtistRange : this.activeTrackRange;
            const items = dataMap[rangeKey] || [];
            return items.length > 5;
          },

          openTopModal(type) {
            this.modalType = type;
            this.showTopModal = true;
            this.updateModalItems();
            document.body.classList.add('modal-open');
          },

          closeTopModal() {
            this.showTopModal = false;
            this.modalItems = [];
            this.modalType = null;
            this.modalTitle = '';
            document.body.classList.remove('modal-open');
          },

          updateModalItems() {
            if (!this.modalType) {
              this.modalItems = [];
              this.modalTitle = '';
              return;
            }
            const dataMap = this.modalType === 'artists' ? this.topArtistsByRange : this.topTracksByRange;
            const rangeKey = this.modalType === 'artists' ? this.activeArtistRange : this.activeTrackRange;
            const items = dataMap[rangeKey] || [];
            this.modalItems = items;
            const label = this.rangeLabels[rangeKey] || rangeKey;
            this.modalTitle = this.modalType === 'artists'
              ? `Top Artists — ${label}`
              : `Top Tracks — ${label}`;
          },

          setGenreSource(source) {
            if (this.activeGenreSource === source) return;
            this.activeGenreSource = source;
            this.renderGenreChart();
          },

          setGenreRange(rangeKey) {
            if (this.activeGenreRange === rangeKey) return;
            this.activeGenreRange = rangeKey;
            this.renderGenreChart();
          },

          renderArtistShowcase() {
            const artists = this.topArtistsByRange[this.activeArtistRange] || [];
            const escapeHtml = (value = '') => String(value)
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;');

            const topArtistsHero = document.getElementById('top-artists-hero');
            if (topArtistsHero) {
              if (!artists.length) {
                topArtistsHero.innerHTML = '<div class="text-sm text-gray-400">No artist data available yet.</div>';
              } else {
                const heroArtists = artists.slice(0, 15);
                topArtistsHero.innerHTML = heroArtists.map((artist, index) => {
                  const primaryGenre = (artist.genres && artist.genres.length > 0) ? artist.genres[0] : null;
                  const bio = artist.bio || (primaryGenre
                    ? `${artist.name} is a ${primaryGenre} artist.`
                    : `${artist.name} is an artist.`);
                  const safeBio = escapeHtml(bio);
                  return `
                    <div class="artist-hero-card flex-shrink-0 w-64 sm:w-72 md:w-80">
                      <div class="relative w-full aspect-square rounded-3xl overflow-hidden shadow-2xl bg-gray-900">
                        ${artist.image
                          ? `<img src="${artist.image}" alt="${artist.name}" class="absolute inset-0 w-full h-full object-cover">`
                          : '<div class="absolute inset-0 bg-gray-700"></div>'}
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/30 to-transparent pointer-events-none"></div>
                        <div class="absolute bottom-3 left-3 text-sm font-semibold text-white bg-black/60 rounded-full px-3 py-1">
                          #${index + 1}
                        </div>
                      </div>
                      <div class="mt-3">
                        <div class="font-semibold text-lg text-white truncate">
                          <a href="${artist.url}" target="_blank" class="hover:text-primary">${artist.name}</a>
                        </div>
                        ${primaryGenre
                          ? `<div class="text-xs uppercase tracking-wide text-primary">${primaryGenre}</div>`
                          : '<div class="text-xs text-gray-500">Genre unavailable</div>'}
                        <p class="text-sm text-gray-300 mt-2 leading-snug">${safeBio}</p>
                      </div>
                    </div>
                  `;
                }).join('');
              }
            }
          },

          renderTopTracksPreview() {
            const tracks = this.topTracksByRange[this.activeTrackRange] || [];
            const previewTracks = tracks.slice(0, 5);
            const topTracksList = document.getElementById('top-tracks-list');
            if (topTracksList) {
              if (!previewTracks.length) {
                topTracksList.innerHTML = '<div class="text-sm text-gray-400">No data available for this range.</div>';
              } else {
                topTracksList.innerHTML = previewTracks.map((track, index) => `
                  <div class="flex items-center gap-3 p-2 hover:bg-gray-800 rounded">
                    <div class="text-sm text-gray-400 w-6">${index + 1}.</div>
                    ${track.cover ? `<img src="${track.cover}" alt="${track.name}" class="w-12 h-12 rounded object-cover flex-shrink-0">` : '<div class="w-12 h-12 rounded bg-gray-700 flex-shrink-0"></div>'}
                    <div class="flex-1 min-w-0">
                      <div class="font-medium">
                        <a href="${track.url}" target="_blank" class="hover:text-primary">${track.name}</a>
                      </div>
                      <div class="text-sm text-gray-400 truncate">${track.artists}</div>
                    </div>
                  </div>
                `).join('');
              }
            }
          },

          renderGenreChart() {
            const container = document.getElementById('top-genres-chart');
            if (!container) return;
            const sourceData = (this.topGenresBySource && this.topGenresBySource[this.activeGenreSource]) || {};
            const genres = sourceData[this.activeGenreRange] || [];
            const escapeHtml = (value = '') => String(value)
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;');
            if (!genres.length) {
              container.innerHTML = '<div class="text-sm text-gray-400">Genre data unavailable.</div>';
              return;
            }

            const maxPercentage = Math.max(...genres.map(g => g.percentage || 0)) || 1;

            // Create compact hierarchical bar chart
            container.innerHTML = genres.map((genre, index) => {
              const percentage = genre.percentage || 0;
              const width = Math.max((percentage / maxPercentage) * 100, 2);
              const label = escapeHtml(genre.genre || 'Unknown');
              const displayPercentage = genre.percentage != null ? `${genre.percentage}%` : '';

              // Color gradient based on ranking
              const hue = 250 - (index * 10);
              const saturation = Math.max(70 - (index * 3), 45);
              const lightness = Math.min(55 + (index * 2), 68);

              // Size-based hierarchy: top genres get larger bars
              const baseHeight = 32;
              const heightBonus = Math.max(0, (genres.length - index) * 2);
              const barHeight = baseHeight + heightBonus;

              return `
                <div class="genre-bar-row" style="animation-delay: ${index * 0.08}s">
                  <div class="genre-bar-header">
                    <div class="genre-bar-rank">${index + 1}</div>
                    <div class="genre-bar-label">${label}</div>
                    <div class="genre-bar-value">${displayPercentage}</div>
                  </div>
                  <div class="genre-bar-container" style="height: ${barHeight}px">
                    <div class="genre-bar-fill"
                         style="width: ${width}%;
                                background: linear-gradient(90deg,
                                  hsl(${hue}, ${saturation}%, ${lightness}%) 0%,
                                  hsl(${hue}, ${saturation}%, ${lightness - 8}%) 100%);
                                box-shadow: 0 0 20px hsla(${hue}, ${saturation}%, ${lightness}%, 0.4);">
                    </div>
                  </div>
                </div>
              `;
            }).join('');
          },

          async loadDashboardStats() {
            if (this.statsLoaded) return; // Only load once

            try {
              const res = await fetch('/api/user-stats');
              const data = await res.json();

              if (!data.ok) {
                console.error('Failed to load stats:', data.error);
                return;
              }

              this.topArtistsByRange = data.top_artists || {};
              this.topTracksByRange = data.top_tracks || {};
              this.topGenresBySource = data.top_genres || { artists: {}, tracks: {} };
              this.rangeLabels = data.range_labels || this.rangeLabels;
              this.rangeOptions = Object.keys(this.topArtistsByRange);
              if (!this.rangeOptions.length) {
                this.rangeOptions = ['short_term', 'medium_term', 'long_term'];
              }
              const preferred = this.rangeOptions.includes('short_term') ? 'short_term' : this.rangeOptions[0];
              this.activeArtistRange = preferred || 'short_term';
              this.activeTrackRange = preferred || 'short_term';
              this.renderArtistShowcase();
              this.renderTopTracksPreview();

              const artistGenreRanges = Object.keys(this.topGenresBySource.artists || {});
              const trackGenreRanges = Object.keys(this.topGenresBySource.tracks || {});
              this.genreRangeOptions = [...new Set([...(artistGenreRanges || []), ...(trackGenreRanges || [])])];
              if (!this.genreRangeOptions.length) {
                this.genreRangeOptions = this.rangeOptions.slice();
              }
              if (!this.genreRangeOptions.includes(this.activeGenreRange)) {
                this.activeGenreRange = this.genreRangeOptions.includes('short_term')
                  ? 'short_term'
                  : (this.genreRangeOptions[0] || 'short_term');
              }
              if (!this.genreSourceOptions.includes(this.activeGenreSource)) {
                this.activeGenreSource = 'artists';
              }
              this.renderGenreChart();

              // Render Recently Played
              const recentlyPlayedList = document.getElementById('recently-played-list');
              if (recentlyPlayedList && data.recently_played) {
                recentlyPlayedList.innerHTML = data.recently_played.slice(0, 30).map(track => `
                  <div class="flex items-center justify-between p-2 hover:bg-gray-800 rounded">
                    <div class="flex-1">
                      <div class="font-medium">
                        <a href="${track.url}" target="_blank" class="hover:text-primary">${track.name}</a>
                      </div>
                      <div class="text-sm text-gray-400">${track.artists}</div>
                    </div>
                  </div>
                `).join('');
              }

              this.statsLoaded = true;
            } catch (err) {
              console.error('Error loading stats:', err);
            }
          }
        }
      }
    </script>

    <!-- Add Alpine.js cloak style to prevent flash of unstyled content -->
    <style>
      [x-cloak] { display: none !important; }
    </style>

    <!-- Icon Attribution Footer -->
    <footer class="icon-attribution">
      <div class="attribution-text">
        Logout Icon made by 
        <a href="https://icons8.com/icon/VTOU0AOwSnkY/logout">Icons8</a>
      </div>
    </footer>
  </body>
</html>
